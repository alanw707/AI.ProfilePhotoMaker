<div class="dashboard-container">
  <!-- Theme Toggle Button -->
  <button class="theme-toggle" (click)="toggleTheme()" [attr.aria-label]="'Switch to ' + (themeService.isDark() ? 'light' : 'dark') + ' theme'">
    <svg *ngIf="!themeService.isDark()" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
    </svg>
    <svg *ngIf="themeService.isDark()" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
  </button>

  <!-- Navigation Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-section">
        <img src="Logo.PNG" alt="AI Profile Photo Maker" class="header-logo">
        <h1>AI Profile Photo Maker</h1>
      </div>
      
      <!-- Navigation Menu -->
      <nav class="nav-menu">
        <a routerLink="/packages" routerLinkActive="active" class="nav-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L3.09 8.26L12 22L20.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
          Packages
        </a>
        <a routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="7" height="9" stroke="currentColor" stroke-width="2"/>
            <rect x="13" y="3" width="8" height="5" stroke="currentColor" stroke-width="2"/>
            <rect x="13" y="12" width="8" height="9" stroke="currentColor" stroke-width="2"/>
            <rect x="3" y="16" width="7" height="5" stroke="currentColor" stroke-width="2"/>
          </svg>
          Studio
        </a>
        <a routerLink="/enhance" routerLinkActive="active" class="nav-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1" stroke="currentColor" stroke-width="2"/>
          </svg>
          Enhance
        </a>
        <a routerLink="/gallery" routerLinkActive="active" class="nav-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" stroke-width="2"/>
            <polyline points="21,15 16,10 5,21" stroke="currentColor" stroke-width="2"/>
          </svg>
          Gallery
        </a>
      </nav>

      <div class="user-section">
        <div class="user-info">
          <span class="user-name">Welcome, {{userName}}!</span>
          <span class="user-email">{{userEmail}}</span>
        </div>
        <button class="btn btn-logout" (click)="logout()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M16 17L21 12M21 12L16 7M21 12H9M9 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Main Dashboard Content -->
  <main class="dashboard-main">
    <div class="dashboard-content">
      
      <!-- Quick Stats -->
      <section class="stats-section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üì∏</div>
            <div class="stat-content">
              <h3>{{uploadedImages}}</h3>
              <p>Selfies Uploaded</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-content">
              <h3>{{generatedPhotos.length}}</h3>
              <p>Photos Generated</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
              <h3>{{modelStatus}}</h3>
              <p>Model Status</p>
            </div>
          </div>
          <div class="stat-card" *ngIf="creditsInfo">
            <div class="stat-icon">üíé</div>
            <div class="stat-content">
              <h3>{{creditsInfo.availableCredits}}</h3>
              <p>Credits</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Credit Status (if user has purchased credits) -->
      <section class="premium-status-section" *ngIf="userCreditStatus && userCreditStatus.purchasedCredits > 0">
        <div class="premium-status-card">
          <div class="status-header">
            <h3>üéØ Credits Available</h3>
            <div class="status-details">
              <span class="package-name">Credit Balance</span>
              <span class="credits-remaining">{{ userCreditStatus.purchasedCredits }} purchased credits</span>
              <span class="expiry-info" *ngIf="userCreditStatus.weeklyCredits > 0">
                + {{ userCreditStatus.weeklyCredits }} weekly credits
              </span>
              <span class="expiry-warning">
                Weekly credits: photo enhancement only ‚Ä¢ Purchased credits: never expire, all features
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- No Package - Get Started Section -->
      <section class="get-started-section" *ngIf="!isPremiumWorkflow()">
        <div class="get-started-card">
          <div class="get-started-header">
            <h2>Welcome to AI Profile Photo Maker</h2>
            <p>Create stunning, professional AI-generated profile photos with our advanced technology</p>
          </div>
          
          <div class="options-grid">
            <div class="option-card premium-option">
              <div class="option-header">
                <div class="option-icon">üéØ</div>
                <h3>Premium Studio</h3>
              </div>
              <div class="option-content">
                <ul>
                  <li>‚ú® Train your own custom AI model</li>
                  <li>üé® Generate photos in multiple professional styles</li>
                  <li>üì∏ Create 5-50 high-quality photos</li>
                  <li>üîí 7-day model expiration for privacy</li>
                </ul>
                <button class="btn btn-primary" routerLink="/packages">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L3.09 8.26L12 22L20.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                  View Packages
                </button>
              </div>
            </div>
            
            <div class="option-card basic-option">
              <div class="option-header">
                <div class="option-icon">‚ö°</div>
                <h3>Basic Enhancement</h3>
              </div>
              <div class="option-content">
                <ul>
                  <li>üñºÔ∏è Background removal & replacement</li>
                  <li>‚ú® Professional lighting & styling</li>
                  <li>üì± Social media optimized photos</li>
                  <li>üé® Creative cartoon transformations</li>
                </ul>
                <button class="btn btn-secondary" routerLink="/enhance">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Enhance Photos
                </button>
              </div>
            </div>
          </div>
          
          <div class="credits-display" *ngIf="creditsInfo">
            <div class="credits-info-card">
              <div class="credits-icon">‚ö°</div>
              <div class="credits-text">
                <span class="credits-count">{{creditsInfo.availableCredits}} Free Credits</span>
                <span class="credits-note">Use for basic photo enhancement</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Workflow Steps -->
      <section class="workflow-section" *ngIf="isPremiumWorkflow()">
        <h2>Create Your Professional Photos</h2>
        <p class="workflow-subtitle">Follow these simple steps to generate stunning AI-powered profile photos</p>
        
        <div class="workflow-steps">
          
          <!-- Step 1: Upload Selfies -->
          <div class="step-card" [class.completed]="uploadedImages > 0" [class.active]="currentStep === 1">
            <div class="step-header">
              <div class="step-number">1</div>
              <div class="step-title">
                <h3>Upload Your Selfies</h3>
                <p>Upload at least 10 high-quality selfies for the best results</p>
              </div>
              <div class="step-status">
                <span class="status-badge" [ngClass]="getStepStatus(1)">
                  {{getStepStatusText(1)}}
                </span>
              </div>
            </div>
            <div class="step-content" *ngIf="currentStep === 1 || uploadedImages === 0 || uploadedImageThumbnails.length > 0">
              <!-- Hidden file input - always available for Upload More Images button -->
              <input type="file" #fileInput multiple accept="image/*" (change)="onFileSelected($event)" style="display: none">
              
              <!-- Show uploaded image thumbnails if we have them -->
              <div class="uploaded-thumbnails" *ngIf="uploadedImageThumbnails.length > 0">
                <h4>Uploaded Images ({{uploadedImageThumbnails.length}})</h4>
                <div class="thumbnail-grid">
                  <div class="thumbnail-item" *ngFor="let thumb of uploadedImageThumbnails; index as i">
                    <img [src]="thumb.url" [alt]="thumb.fileName">
                    <button class="delete-thumbnail-btn" 
                            (click)="deleteUploadedImage(thumb, i)" 
                            title="Delete image">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <p class="upload-status">‚úÖ {{uploadedImageThumbnails.length}} images ready for training</p>
              </div>

              <!-- Upload area for new images -->
              <div class="upload-area" 
                   *ngIf="uploadedImageThumbnails.length === 0"
                   (click)="triggerFileUpload()"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onDrop($event)"
                   [class.drag-over]="isDragOver">
                <div class="upload-icon">üì∑</div>
                <h4>Drop your selfies here or click to browse</h4>
                <p>Maximum 20 images ‚Ä¢ JPG, PNG, WebP ‚Ä¢ Up to 5MB each</p>
              </div>
              
              <!-- Selected files preview (before upload) -->
              <div class="uploaded-images" *ngIf="selectedFiles.length > 0">
                <div class="image-preview" *ngFor="let file of selectedFiles; index as i">
                  <img [src]="getFilePreview(file)" alt="Preview">
                  <button class="remove-btn" (click)="removeFile(i)">√ó</button>
                </div>
              </div>
              
              <button class="btn btn-primary" 
                      *ngIf="selectedFiles.length > 0" 
                      (click)="uploadImages()"
                      [disabled]="isUploading">
                <span *ngIf="isUploading">Uploading... {{uploadProgress}}%</span>
                <span *ngIf="!isUploading">Upload {{selectedFiles.length}} Images</span>
              </button>
              
              <!-- Upload Progress Bar -->
              <div class="upload-progress" *ngIf="isUploading">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="uploadProgress"></div>
                </div>
                <p class="progress-text">{{uploadProgress}}% uploaded</p>
              </div>

              <!-- Option to upload more images -->
              <button class="btn btn-secondary" 
                      *ngIf="uploadedImageThumbnails.length > 0 && !isUploading" 
                      (click)="triggerFileUpload()">
                Upload More Images
              </button>
            </div>
          </div>

          <!-- Step 2: Generate Images -->
          <div class="step-card" [class.completed]="generatedPhotos.length > 0" [class.active]="currentStep === 2">
            <div class="step-header">
              <div class="step-number">2</div>
              <div class="step-title">
                <h3>Generate Your Professional Photos</h3>
                <p *ngIf="modelStatus !== 'trained'">Select styles and we'll train your model then generate photos</p>
                <p *ngIf="modelStatus === 'trained'">Select styles to generate photos with your trained model</p>
              </div>
              <div class="step-status">
                <span class="status-badge" [ngClass]="getStepStatus(2)">
                  {{getStepStatusText(2)}}
                </span>
              </div>
            </div>
            <div class="step-content" *ngIf="currentStep === 2">
              <!-- Credit Cost Information -->
              <div class="credit-info-box">
                <h5>üí≥ Credit Costs</h5>
                <div class="cost-breakdown">
                  <div class="cost-item">
                    <span>Model Training:</span>
                    <span><strong>{{creditService.getCreditCostSync('model_training')}} credits</strong> (one-time)</span>
                  </div>
                  <div class="cost-item">
                    <span>Styled Generation:</span>
                    <span><strong>{{creditService.getCreditCostSync('styled_generation')}} credits</strong> per image</span>
                  </div>
                </div>
                <p class="cost-note">Select styles based on your available credits: <strong>{{creditsInfo?.availableCredits || 0}} credits</strong></p>
              </div>
              
              <!-- Style Selection Controls -->
              <div class="style-controls">
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="selectAllStyles()">
                  Select All
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="deselectAllStyles()">
                  Deselect All
                </button>
                <span class="selection-count">{{selectedStyles}} of {{availableStyles.length}} styles selected</span>
              </div>
              
              <div class="styles-grid-compact">
                <div class="style-option" 
                     *ngFor="let style of availableStyles" 
                     [class.selected]="style.selected"
                     (click)="toggleStyle(style)">
                  <div class="style-checkbox">
                    <input type="checkbox" [checked]="style.selected" (change)="toggleStyle(style)" (click)="$event.stopPropagation()">
                  </div>
                  <div class="style-preview">
                    <img [src]="style.previewUrl" [alt]="style.name + ' style preview'" (error)="onImageError($event)">
                  </div>
                  <div class="style-info">
                    <h4>{{style.name}}</h4>
                    <p>{{style.description}}</p>
                  </div>
                </div>
              </div>
              
              <div class="style-selection-summary" *ngIf="selectedStyles > 0">
                <p><strong>{{selectedStyles}} styles selected</strong></p>
                <div class="credit-breakdown">
                  <div class="credit-item">
                    <span class="credit-label">Model Training:</span>
                    <span class="credit-cost">{{calculateTrainingCredits()}} credits</span>
                  </div>
                  <div class="credit-item">
                    <span class="credit-label">Image Generation:</span>
                    <span class="credit-cost">{{calculateGenerationCredits()}} credits</span>
                  </div>
                  <div class="credit-item total-credits">
                    <span class="credit-label">Total Cost:</span>
                    <span class="credit-cost"><strong>{{calculateTotalCredits()}} credits</strong></span>
                  </div>
                  <div class="credit-item remaining-credits" [class.insufficient]="!hasEnoughCredits()">
                    <span class="credit-label">Remaining Credits:</span>
                    <span class="credit-cost">
                      <strong [class.negative]="!hasEnoughCredits()">{{getRemainingCredits()}} credits</strong>
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Insufficient Credits Warning -->
              <div class="insufficient-credits-warning" *ngIf="selectedStyles > 0 && !hasEnoughCredits()">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-content">
                  <h5>Insufficient Credits</h5>
                  <p>You need {{calculateTotalCredits() - (creditsInfo?.availableCredits || 0)}} more credits to complete this operation.</p>
                  <button class="btn btn-secondary btn-sm" routerLink="/credit-packages">
                    Purchase Credits
                  </button>
                </div>
              </div>
              
              <!-- Number of images per style selection -->
              <div class="image-count-selection" *ngIf="selectedStyles > 0">
                <h5>Images to Generate per Style</h5>
                <div class="count-options">
                  <label class="count-option" *ngFor="let count of [1, 2, 3, 4, 5]">
                    <input type="radio" 
                           name="imageCount" 
                           [value]="count" 
                           [(ngModel)]="imagesPerStyle"
                           [checked]="imagesPerStyle === count">
                    <span>{{count}} image{{count > 1 ? 's' : ''}}</span>
                  </label>
                </div>
                <p class="count-note">Total: {{selectedStyles * imagesPerStyle}} images will be generated</p>
              </div>
              
              <!-- Action Button: Training or Generation -->
              <button class="btn btn-primary" 
                      *ngIf="selectedStyles > 0 && !isTrainingStarted" 
                      (click)="startTrainingWithStyles()"
                      [disabled]="modelStatus === 'training' || !uploadedImages || uploadedImages < 5 || !hasEnoughCredits()">
                <span *ngIf="modelStatus === 'training'">Starting Training...</span>
                <span *ngIf="modelStatus === 'trained'">Generate Photos with {{selectedStyles}} Selected Styles ({{selectedStyles * imagesPerStyle}} total images)</span>
                <span *ngIf="modelStatus !== 'training' && modelStatus !== 'trained'">Start Training with {{selectedStyles}} Selected Styles ({{selectedStyles * imagesPerStyle}} total images)</span>
              </button>
              
              <div class="training-note" *ngIf="selectedStyles === 0">
                <p>Select at least one style to proceed with training</p>
              </div>
              
              <div class="training-note" *ngIf="selectedStyles > 0 && uploadedImages < 5">
                <p>Upload at least 5 images to enable training</p>
              </div>
              
              <!-- Training Progress (only shown when actively training) -->
              <div class="training-progress-section" *ngIf="modelStatus === 'training'">
                <div class="training-progress">
                  <div class="progress-circle">
                    <div class="progress-text">{{trainingProgress}}%</div>
                  </div>
                  <div class="training-info">
                    <h4>üöÄ Training Your AI Model</h4>
                    <p>This usually takes 15-25 minutes. You'll be notified when it's complete!</p>
                    <p class="eta">Estimated completion: {{estimatedCompletion}}</p>
                  </div>
                </div>
              </div>
              
              <!-- Generation Progress (only shown when actively generating) -->
              <div class="generation-progress-section" *ngIf="isGenerating">
                <div class="progress-indicator">
                  <div class="spinner"></div>
                  <h4>üé® Generating Your Photos</h4>
                  <p>Creating professional photos with your selected styles...</p>
                  <p class="progress-detail">This usually takes 2-5 minutes per style</p>
                </div>
              </div>
              
              <!-- Generated Photos Results -->
              <div class="generated-results" *ngIf="generatedPhotos.length > 0">
                <h4>üéâ Your Professional Photos Are Ready!</h4>
                <div class="results-grid">
                  <div class="result-card" *ngFor="let photo of generatedPhotos">
                    <img [src]="photo.url" [alt]="photo.style">
                    <div class="result-overlay">
                      <h4>{{photo.style}}</h4>
                      <div class="result-actions">
                        <button class="btn btn-sm btn-download" (click)="downloadPhoto(photo)">
                          Download
                        </button>
                        <button class="btn btn-sm btn-share" (click)="sharePhoto(photo)">
                          Share
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="bulk-actions" *ngIf="generatedPhotos.length > 1">
                  <button class="btn btn-primary" (click)="downloadAll()" [disabled]="isDownloadingZip">
                    <div class="spinner" *ngIf="isDownloadingZip" style="margin-right: 8px; width: 16px; height: 16px;"></div>
                    <svg *ngIf="!isDownloadingZip" width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">
                      <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
                      <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
                      <path d="M12 18L8 14M12 18L16 14M12 18V11" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span *ngIf="isDownloadingZip">Creating ZIP...</span>
                    <span *ngIf="!isDownloadingZip">Download All as ZIP ({{generatedPhotos.length}} photos)</span>
                  </button>
                </div>
                <div class="view-gallery-action">
                  <button class="btn btn-secondary" routerLink="/gallery">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" stroke-width="2"/>
                      <polyline points="21,15 16,10 5,21" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    View All Photos in Gallery
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>



    </div>
  </main>
</div>
